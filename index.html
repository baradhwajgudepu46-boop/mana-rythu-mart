<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mana Rythu Mart</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f7f9f7; color: #333; overflow-x: hidden; }
    header {
      background-color: #fff;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: 3px solid #66bb6a;
    }
    header .logo-container { display:flex; align-items:center; }
    header .logo-container img { height:50px; margin-right:15px; }
    header .logo-text {
      font-size:28px; font-weight:bold; color:#4CAF50; text-decoration:none;
      text-transform:uppercase; letter-spacing:1.5px;
      text-shadow:1px 1px 2px rgba(0,0,0,.1);
    }
    nav a {
      margin:0 15px; text-decoration:none; color:#555; font-weight:600;
      transition:color .3s ease;
    }
    nav a:hover { color:#66bb6a; }
    .search-container { flex-grow:1; margin:10px 20px; display:flex; position:relative; }
    .search-container input {
      width:100%; padding:12px 15px; border:2px solid #ddd; border-radius:50px; font-size:16px;
      transition:border-color .3s ease;
    }
    .search-container input:focus { outline:none; border-color:#4CAF50; }
    main { padding:40px; }
    h2, h3 {
      color:#388e3c; border-bottom:2px solid #a5d6a7; padding-bottom:10px; margin-bottom:20px;
    }
    .product-grid {
      display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:30px;
    }
    .product-card {
      background-color:#fff; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.08);
      padding:25px; text-align:center; transition:transform .3s ease, box-shadow .3s ease;
    }
    .product-card:hover { transform:translateY(-5px); box-shadow:0 10px 30px rgba(0,0,0,.15); }
    .product-card img {
      max-width:100%; height:200px; object-fit:contain; border-radius:8px; margin-bottom:15px;
    }
    .product-card h3 { margin-top:0; color:#2e7d32; }
    .product-card .price { font-size:1.4em; color:#ff5722; font-weight:bold; margin:10px 0; }
    .product-card button {
      background-color:#4CAF50; color:#fff; border:none; padding:12px 25px; cursor:pointer;
      border-radius:50px; font-size:16px; margin-top:15px; transition:background-color .3s ease;
    }
    .product-card button:hover { background-color:#388e3c; }
    .product-card.disabled { opacity:.5; pointer-events:none; }

    .cart-page, .orders-page, .admin-page, #payment-gateway-page {
      background-color:#fff; padding:40px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.08);
    }
     #login-page {
      background-color:#fff; padding:40px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.08);
      margin-top: 30px;
    }
    .cart-item {
      display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:15px 0;
    }
    .cart-item .controls { display:flex; gap:15px; align-items:center; }
    .checkout-form { display:flex; flex-direction:column; gap:15px; margin-top:30px; }
    .checkout-form input, .checkout-form select, .checkout-form textarea {
      padding:12px 15px; border:1px solid #ccc; border-radius:8px;
    }

    .admin-page form {
      display:flex; flex-direction:column; gap:20px; margin-bottom:40px; padding:20px;
      background-color:#f9f9f9; border-radius:8px;
    }
    .admin-page form input, .admin-page form textarea {
      padding:12px; border:1px solid #ddd; border-radius:5px;
    }
    .admin-page table { width:100%; border-collapse:collapse; margin-top:20px; }
    .admin-page th, .admin-page td {
      padding:15px; text-align:left; border-bottom:1px solid #eee;
    }
    .admin-page th { background-color:#e8f5e9; }
    .admin-page .actions button {
      background:none; border:none; cursor:pointer; font-size:18px; margin:0 6px; color:#555; transition:color .3s ease;
    }
    .admin-page .actions button:hover { color:#4CAF50; }
    .status-select { padding:6px 8px; border-radius:6px; border:1px solid #ddd; }
    .empty-row td { text-align:center; color:#777; padding:24px; }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-footer {
      text-align: right;
      margin-top: 20px;
    }
    .modal-footer button {
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        margin-left: 10px;
    }
    .modal-footer button.primary {
        background-color: #4CAF50;
        color: white;
    }
    .modal-footer button.secondary {
        background-color: #ddd;
        color: black;
    }

    /* Splash Screen Styles */
    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease-out;
    }
    #splash-screen img {
      height: 100px;
      margin-bottom: 20px;
    }
    #splash-screen span {
      font-size: 36px;
      font-weight: bold;
      color: #4CAF50;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      text-shadow:1px 1px 2px rgba(0,0,0,.1);
    }
    .splash-hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* Quantity Controls on Product Card */
    .quantity-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
    }
    .quantity-controls button {
      background-color: #4CAF50;
      color: #fff;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color .3s ease;
      padding: 0;
    }
    .quantity-controls button:hover {
      background-color: #388e3c;
    }
    .quantity-controls span {
      font-size: 1.2em;
      font-weight: bold;
      min-width: 20px;
      text-align: center;
    }
    
    /* Order Item Styles */
    .order-item {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,.07);
      padding: 20px;
      margin-bottom: 20px;
      border-left: 5px solid #66bb6a;
    }
    .order-item h4 {
      margin-top: 0;
      color: #388e3c;
      font-size: 1.2em;
      margin-bottom: 15px;
    }
    .order-item p {
      margin: 5px 0;
      color: #555;
    }
    .order-item ul {
      list-style-type: none;
      padding-left: 0;
      margin-top: 15px;
    }
    .order-item li {
      background-color: #f9f9f9;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 5px;
    }
    .order-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9em;
        color: #fff;
    }
    .status-Pending, .status-Pending_Payment { background-color: #ffc107; }
    .status-Confirmed { background-color: #2196F3; }
    .status-Shipped { background-color: #9C27B0; }
    .status-Delivered { background-color: #4CAF50; }
    .status-Cancelled { background-color: #f44336; }

  </style>
</head>
<body>
  <div id="splash-screen">
    <img src="https://lh3.googleusercontent.com/d/1qHvVgzqBnqMFZbs4LO3WxRso052F4LGx" alt="Mana Rythu Mart Logo"/>
    <span>Mana Rythu Mart</span>
     <!-- Auth -->
    <section id="login-page">
      <h2>Login / Sign Up</h2>
      <form id="login-form">
        <input type="email" id="email" placeholder="Email" required />
        <input type="password" id="password" placeholder="Password" required />
        <button type="submit">Login</button>
      </form>
      <button id="signup-button">Sign Up</button>
      <button id="reset-password-button">Reset Password</button>
    </section>
  </div>

  <header>
    <a href="#home" class="logo-container">
      <img src="https://lh3.googleusercontent.com/d/1qHvVgzqBnqMFZbs4LO3WxRso052F4LGx" alt="Mana Rythu Mart Logo"/>
      <span class="logo-text">Mana Rythu Mart</span>
    </a>
    <div class="search-container">
      <input type="text" id="search-input" placeholder="Search for products..."/>
    </div>
    <nav>
      <a href="#home" id="home-link">Home</a>
      <a href="#cart" id="cart-link">Cart (<span id="cart-count">0</span>)</a>
      <a href="#orders" id="orders-link">Orders</a>
      <a href="#login" id="login-link">Login</a>
      <a href="#admin" id="admin-link" style="display: none;">Admin</a>
    </nav>
  </header>

  <main class="container">
    <!-- Home -->
    <section id="home-page" style="display:none;">
      <h2>Our Products</h2>
      <div id="product-list" class="product-grid">
        <div class="loading">Loading products...</div>
      </div>
    </section>

    <!-- Cart -->
    <section id="cart-page" style="display:none;">
      <h2>Your Cart</h2>
      <div id="cart-list"></div>
      <div id="cart-total">Total: ₹0</div>
      <form id="checkout-form" class="checkout-form">
        <h3>Customer Details</h3>
        <input type="text" id="name" placeholder="Name" required />
        <input type="tel" id="phone" placeholder="Phone Number" required />
        <textarea id="address" placeholder="Shipping Address" required></textarea>
        <label for="payment-method">Payment Method:</label>
        <select id="payment-method">
          <option value="cod">Cash on Delivery (COD)</option>
          <option value="upi">Pay with UPI / QR Code</option>
        </select>
        <button type="submit">Place Order</button>
      </form>
    </section>

    <!-- Customer Orders -->
    <section id="orders-page" style="display:none;">
      <h2>Your Orders</h2>
      <div id="orders-list"></div>
    </section>
    
    <!-- Payment Gateway Page -->
    <section id="payment-gateway-page" style="display:none;">
        <div style="text-align: center; max-width: 500px; margin: auto;">
            <h2>Complete Your Payment</h2>
            <p style="margin-bottom: 15px;">Scan the QR code below with your UPI app to pay.</p>
            <h3 style="font-size: 1.8em; margin-bottom: 15px;">Total Amount: <strong id="payment-amount">₹0.00</strong></h3>
            <img src="https://lh3.googleusercontent.com/d/17r48JjzNwt0UtjnOOpW5ByQQrNQzZD-5" alt="Scan to Pay" style="width: 250px; height: auto; margin: 0 auto; border: 1px solid #ddd;"/>
            <p style="margin-top: 20px; font-size: 0.9em; color: #555;">After completing the payment, your order status will be updated to 'Confirmed' by our team once we verify the transaction.</p>
            <button id="payment-complete-btn" class="product-card button" style="margin-top: 25px;">I Have Paid</button>
        </div>
    </section>


    <!-- Admin -->
    <section id="admin-page" style="display:none;">
      <h2>Admin Dashboard</h2>

      <h3>Add / Edit Product</h3>
      <form id="product-form">
        <input type="hidden" id="product-id" />
        <input type="text" id="product-name" placeholder="Product Name" required />
        <textarea id="product-description" placeholder="Description"></textarea>
        <input type="text" id="product-price" placeholder="Price (₹)" required />
        <input type="text" id="product-image" placeholder="Image URL" />
        <input type="text" id="product-category" placeholder="Category (e.g., fruits, vegetables)" />
        <button type="submit" id="product-form-button">Add Product</button>
      </form>

      <h3>Manage Orders</h3>
      <label for="order-filter"><strong>Filter by Status:</strong></label>
      <select id="order-filter">
        <option value="all">All</option>
        <option value="Pending">Pending</option>
        <option value="Pending Payment">Pending Payment</option>
        <option value="Confirmed">Confirmed</option>
        <option value="Shipped">Shipped</option>
        <option value="Delivered">Delivered</option>
        <option value="Cancelled">Cancelled</option>
      </select>

      <table id="admin-orders-table">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Address</th>
            <th>Total</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="admin-orders-list"></tbody>
      </table>
      
      <!-- Order Edit Modal -->
      <div id="order-edit-modal" class="modal">
          <div class="modal-content">
              <h3>Update Order</h3>
              <form id="order-edit-form">
                  <input type="hidden" id="edit-order-id" />
                  <label>Status:</label>
                  <select id="edit-order-status">
                      <option value="Pending">Pending</option>
                      <option value="Pending Payment">Pending Payment</option>
                      <option value="Confirmed">Confirmed</option>
                      <option value="Shipped">Shipped</option>
                      <option value="Delivered">Delivered</option>
                      <option value="Cancelled">Cancelled</option>
                  </select>
                  <button type="submit">Update Order</button>
              </form>
          </div>
      </div>


      <h3>Manage Products</h3>
      <table>
        <thead>
          <tr>
            <th>Name</th><th>Price</th><th>Category</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="admin-product-list"></tbody>
      </table>
    </section>
  </main>
  
  <!-- Generic Modal -->
  <div id="generic-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title" style="margin-top:0;"></h3>
      <div id="modal-body"></div>
      <div id="modal-footer"></div>
    </div>
  </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot, doc, setDoc, addDoc,
      updateDoc, deleteDoc, getDoc, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendPasswordResetEmail, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAb1dGJmkTyAdAw3UzeZOg9lHRQsgqHtiA",
      authDomain: "mana-rythu-mart-ae759.firebaseapp.com",
      projectId: "mana-rythu-mart-ae759",
      storageBucket: "mana-rythu-mart-ae759.firebasestorage.app",
      messagingSenderId: "484608823115",
      appId: "1:484608823115:web:cb854b3d3cd08bc9c22ce",
      measurementId: "G-QL84PQX2GV"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Globals
    const pages = document.querySelectorAll('main > section');
    const navLinks = document.querySelectorAll('nav a');
    const homeLink = document.getElementById('home-link');
    const cartLink = document.getElementById('cart-link');
    const ordersLink = document.getElementById('orders-link');
    const loginLink = document.getElementById('login-link');
    const adminLink = document.getElementById('admin-link');

    const productList = document.getElementById('product-list');
    const cartCountSpan = document.getElementById('cart-count');
    const cartList = document.getElementById('cart-list');
    const cartTotalSpan = document.getElementById('cart-total');
    const checkoutForm = document.getElementById('checkout-form');

    const loginForm = document.getElementById('login-form');
    const signupButton = document.getElementById('signup-button');
    const resetButton = document.getElementById('reset-password-button');

    const adminProductList = document.getElementById('admin-product-list');
    const productForm = document.getElementById('product-form');

    const ordersList = document.getElementById('orders-list');

    const adminOrdersList = document.getElementById('admin-orders-list');
    const orderFilter = document.getElementById('order-filter');
    const orderEditModal = document.getElementById('order-edit-modal');
    const orderEditForm = document.getElementById('order-edit-form');

    const genericModal = document.getElementById('generic-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalFooter = document.getElementById('modal-footer');
    
    const splashScreen = document.getElementById('splash-screen');
    const paymentCompleteBtn = document.getElementById('payment-complete-btn');

    let cart = {};
    let products = [];
    let isAdmin = false;
    let currentUser = null;
    let allOrders = [];

    function showSplashScreen() {
        if (splashScreen) {
            splashScreen.classList.remove('splash-hidden');
            splashScreen.style.display = 'flex';
        }
    }

    function hideSplashScreen() {
        if (splashScreen) {
            splashScreen.classList.add('splash-hidden');
            setTimeout(() => {
                if(splashScreen) splashScreen.style.display = 'none';
            }, 500);
        }
    }
    
    window.closeModal = function() {
        if(genericModal) genericModal.style.display = 'none';
        if(orderEditModal) orderEditModal.style.display = 'none';
    }

    function showAlert(title, message) {
        modalTitle.innerHTML = title;
        modalBody.innerHTML = message;
        modalFooter.innerHTML = `<button class="primary" onclick="closeModal()">OK</button>`;
        if(genericModal) genericModal.style.display = 'block';
    }

    function showConfirm(title, message, onConfirm) {
        modalTitle.innerHTML = title;
        modalBody.innerHTML = message;
        modalFooter.innerHTML = `
            <button class="secondary" onclick="closeModal()">Cancel</button>
            <button class="primary" id="confirm-btn">Confirm</button>
        `;
        if(genericModal) genericModal.style.display = 'block';
        document.getElementById('confirm-btn').onclick = () => {
            closeModal();
            onConfirm();
        };
    }

    function showPage(id) {
      pages.forEach(page => (page.style.display = 'none'));
      const target = document.getElementById(id);
      if (target) target.style.display = 'block';
    }

    function displayProducts(items) {
      productList.innerHTML = '';
      items.forEach(product => {
        const card = document.createElement('div');
        card.classList.add('product-card');
        card.innerHTML = `
          <img src="${product.image}" alt="${product.name}"
               onerror="this.onerror=null;this.src='https://placehold.co/600x400?text=Image+Not+Found';">
          <h3>${product.name}</h3>
          <p>${product.description || ''}</p>
          <p class="price">₹${product.price}</p>
          <div id="controls-${product.id}">
             <button onclick="addToCart('${product.id}')">Add to Cart</button>
          </div>
        `;
        productList.appendChild(card);
      });
    }

    function renderAdminProducts(items) {
      adminProductList.innerHTML = '';
      items.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${product.name}</td>
          <td>₹${product.price}</td>
          <td>${product.category || 'N/A'}</td>
          <td>${product.status || 'N/A'}</td>
          <td class="actions">
            <button onclick="editProduct('${product.id}')" title="Edit">✏️</button>
            <button onclick="deleteProduct('${product.id}')" title="Delete">🗑️</button>
            <button onclick="toggleProductStatus('${product.id}', '${product.status || 'active'}')"
              title="${product.status === 'active' ? 'Disable' : 'Enable'}">
              ${product.status === 'active' ? 'Disable' : 'Enable'}
            </button>
          </td>
        `;
        adminProductList.appendChild(row);
      });
    }

    function loadProductsAndRenderBasedOnAuth() {
      onSnapshot(collection(db, "products"), snapshot => {
        products = snapshot.docs.map(docu => ({ id: docu.id, ...docu.data() }));
        const activeProducts = products.filter(p => p.status !== 'disabled');
        displayProducts(activeProducts);
        if (isAdmin) renderAdminProducts(products);
      }, err => console.error("Product listener failed:", err));
    }

    function loadCart() {
      if (!currentUser) return;
      onSnapshot(collection(db, `users/${currentUser.uid}/cart`), snapshot => {
        cart = {};
        snapshot.docs.forEach(d => (cart[d.id] = d.data().quantity));
        updateCartUI();
      }, err => console.error("Cart listener failed:", err));
    }

    function updateCartUI() {
      cartCountSpan.textContent = Object.values(cart).reduce((s, q) => s + q, 0);
      cartList.innerHTML = '';
      let total = 0;
      const cartIds = Object.keys(cart);

      if (cartIds.length === 0) {
        cartList.innerHTML = '<p>Your cart is empty.</p>';
        cartTotalSpan.textContent = 'Total: ₹0';
      } else {
          const allProducts = products;
          cartIds.forEach(id => {
            const product = allProducts.find(p => p.id === id);
            if (!product) return;
            const quantity = cart[id];
            const itemTotal = product.price * quantity;
            total += itemTotal;
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('cart-item');
            itemDiv.innerHTML = `
              <span>${product.name} - ₹${product.price} x ${quantity}</span>
              <div class="controls">
                <button onclick="updateCart('${id}', -1)">-</button>
                <span>${quantity}</span>
                <button onclick="updateCart('${id}', 1)">+</button>
              </div>
            `;
            cartList.appendChild(itemDiv);
          });
          cartTotalSpan.textContent = `Total: ₹${total}`;
      }

      products.forEach(product => {
        const controlsContainer = document.getElementById(`controls-${product.id}`);
        if (controlsContainer) {
            const quantity = cart[product.id] || 0;
            let controlsHtml;
            if (quantity > 0) {
                controlsHtml = `
                    <div class="quantity-controls">
                        <button onclick="updateCart('${product.id}', -1)">-</button>
                        <span>${quantity}</span>
                        <button onclick="updateCart('${product.id}', 1)">+</button>
                    </div>
                `;
            } else {
                controlsHtml = `<button onclick="addToCart('${product.id}')">Add to Cart</button>`;
            }
            controlsContainer.innerHTML = controlsHtml;
        }
      });
    }

    window.updateCart = function(productId, change) {
      if (!currentUser) return;
      const itemRef = doc(db, `users/${currentUser.uid}/cart`, productId);
      getDoc(itemRef).then(snap => {
        if (snap.exists()) {
          const newQuantity = snap.data().quantity + change;
          if (newQuantity > 0) updateDoc(itemRef, { quantity: newQuantity });
          else deleteDoc(itemRef);
        } else if (change > 0) {
          setDoc(itemRef, { quantity: 1 });
        }
      }).catch(err => console.error('Error updating cart: ', err));
    }
    
    window.addToCart = function(productId) {
      updateCart(productId, 1);
    }

    function loadOrders() {
      if (!currentUser) return;
      const qy = query(collection(db, "orders"), where('userId', '==', currentUser.uid));
      onSnapshot(qy, snapshot => {
        ordersList.innerHTML = '';
        if (snapshot.empty) {
          ordersList.innerHTML = '<p class="text-center p-4">You have not placed any orders yet.</p>';
          return;
        }
        const sortedDocs = snapshot.docs.sort((a, b) => b.data().timestamp.toMillis() - a.data().timestamp.toMillis());
        
        sortedDocs.forEach(orderDoc => {
          const order = orderDoc.data();
          const status = (order.status || 'Pending').replace(' ', '_');
          const itemsHtml = (order.items || []).map(item => {
            const prod = products.find(p => p.id === item.productId);
            const name = prod ? prod.name : 'Unknown Product';
            return `<li>${name} x ${item.quantity}</li>`;
          }).join('');
          const dt = order.timestamp?.toDate();
          const dateStr = dt ? dt.toLocaleString() : 'N/A';

          let payButtonHtml = '';
          if (order.status === 'Pending Payment') {
              payButtonHtml = `<button class="product-card button" style="margin-top: 15px;" onclick="retryPayment('${orderDoc.id}', ${order.total || 0})">Pay Now</button>`;
          }

          const orderDiv = document.createElement('div');
          orderDiv.classList.add('order-item');
          orderDiv.innerHTML = `
            <h4>Order ID: ${orderDoc.id}</h4>
            <p><strong>Date:</strong> ${dateStr}</p>
            <p><strong>Total:</strong> ₹${(order.total || 0).toFixed(2)}</p>
            <p><strong>Status:</strong> <span class="order-status status-${status}">${order.status || 'Pending'}</span></p>
            <h4>Items Ordered:</h4>
            <ul>${itemsHtml}</ul>
            ${payButtonHtml}
          `;
          ordersList.appendChild(orderDiv);
        });
      }, err => console.error("Orders listener failed:", err));
    }

    window.retryPayment = function(orderId, total) {
        document.getElementById('payment-amount').innerHTML = `<strong>₹${total.toFixed(2)}</strong>`;
        showPage('payment-gateway-page');
    }

    function loadAdminOrders() {
      onSnapshot(collection(db, "orders"), snapshot => {
        allOrders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderAdminOrdersFiltered();
      }, err => console.error("Admin orders listener failed:", err));
    }

    function renderAdminOrdersFiltered() {
      const filter = orderFilter.value;
      const list = filter === 'all' ? allOrders : allOrders.filter(o => (o.status || 'Pending') === filter);
      renderAdminOrders(list);
    }

    function renderAdminOrders(orders) {
      adminOrdersList.innerHTML = '';
      if (!orders.length) {
        adminOrdersList.innerHTML = `<tr class="empty-row"><td colspan="7">No orders found.</td></tr>`;
        return;
      }
      orders.forEach(order => {
        const dateStr = order.timestamp?.toDate().toLocaleString() || 'N/A';
        const statusValue = order.status || 'Pending';
        const customer = `${order.customerName || 'N/A'}${order.customerPhone ? ' (' + order.customerPhone + ')' : ''}`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${order.id}</td><td>${customer}</td><td>${order.customerAddress || 'N/A'}</td><td>₹${order.total || 0}</td>
          <td><select class="status-select" onchange="updateOrderStatus('${order.id}', this.value)">
              ${['Pending', 'Pending Payment', 'Confirmed','Shipped','Delivered','Cancelled'].map(s => `<option value="${s}" ${s===statusValue?'selected':''}>${s}</option>`).join('')}
          </select></td><td>${dateStr}</td>
          <td class="actions">
            <button title="View items" onclick="viewOrder('${order.id}')">👁️</button>
            <button title="Delete order" onclick="deleteOrderById('${order.id}')">🗑️</button>
            <button title="Update order" onclick="editOrder('${order.id}')">✏️</button>
          </td>`;
        adminOrdersList.appendChild(tr);
      });
    }

    window.updateOrderStatus = function(orderId, newStatus) {
      if (!isAdmin) return showAlert('Permission Denied', 'You do not have permission.');
      updateDoc(doc(db, "orders", orderId), { status: newStatus })
        .catch(err => showAlert('Error', 'Failed to update status: ' + err.message));
    };

    window.deleteOrderById = function(orderId) {
      if (!isAdmin) return showAlert('Permission Denied', 'You do not have permission.');
      showConfirm('Delete Order', 'Are you sure?', () => {
        deleteDoc(doc(db, "orders", orderId))
          .catch(err => showAlert('Error', 'Failed to delete: ' + err.message));
      });
    };

    window.viewOrder = function(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (!order) return;
      const details = (order.items || []).map(item => `<li>• ${products.find(p=>p.id===item.productId)?.name || 'Unknown'} — ${item.quantity} × ₹${item.price||0} = ₹${((item.price||0) * item.quantity).toFixed(2)}</li>`).join('');
      showAlert(`Order Details`, `<p><strong>Customer:</strong> ${order.customerName||''}</p><p><strong>Address:</strong> ${order.customerAddress||''}</p><p><strong>Phone:</strong> ${order.customerPhone||''}</p><p><strong>Total:</strong> ₹${(order.total||0).toFixed(2)}</p><p><strong>Status:</strong> ${order.status||'Pending'}</p><hr style="margin: 10px 0;"/><p><strong>Items:</strong></p><ul style="list-style-position: inside;">${details||'<li>No items</li>'}</ul>`);
    };
    
    window.editOrder = function(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (!order) return showAlert('Error', 'Order not found');
      document.getElementById('edit-order-id').value = order.id;
      document.getElementById('edit-order-status').value = order.status || 'Pending';
      orderEditModal.style.display = 'block';
    };

    orderEditForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('edit-order-id').value;
      const status = document.getElementById('edit-order-status').value;
      updateDoc(doc(db, "orders", id), { status })
        .then(() => {
          showAlert('Success', 'Order updated!');
          closeModal();
          renderAdminOrdersFiltered();
        })
        .catch(error => showAlert('Error', 'Error updating order: ' + error.message));
    });

    window.editProduct = function(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;
      productForm['product-id'].value = product.id;
      productForm['product-name'].value = product.name;
      productForm['product-description'].value = product.description || '';
      productForm['product-price'].value = product.price;
      productForm['product-image'].value = product.image || '';
      productForm['product-category'].value = product.category || '';
      document.getElementById('product-form-button').textContent = 'Update Product';
      showPage('admin-page');
    };

    window.deleteProduct = function(id) {
      showConfirm('Delete Product', 'Are you sure?', () => {
        deleteDoc(doc(db, "products", id))
          .then(() => showAlert('Success', 'Product deleted!'))
          .catch(error => showAlert('Error', 'Error deleting: ' + error.message));
      });
    };

    window.toggleProductStatus = function(id, currentStatus) {
      if (!isAdmin) return showAlert('Permission Denied', 'You do not have permission.');
      const newStatus = currentStatus === 'active' ? 'disabled' : 'active';
      updateDoc(doc(db, "products", id), { status: newStatus })
        .then(() => showAlert('Success', 'Product status updated to ' + newStatus))
        .catch(error => showAlert('Error', 'Error updating: ' + error.message));
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        loginLink.textContent = 'Logout';
        const userDocRef = doc(db, "users", user.uid);
        try {
          const userSnap = await getDoc(userDocRef);
          isAdmin = userSnap.exists() && userSnap.data().isAdmin === true;
        } catch (e) {
          console.error(`Error getting user document at ${userDocRef.path}:`, e);
          isAdmin = false;
        }
        adminLink.style.display = isAdmin ? 'inline' : 'none';
        loadCart();
        loadOrders();
        loadProductsAndRenderBasedOnAuth();
        if (isAdmin) loadAdminOrders();
        
        hideSplashScreen();
        showPage('home-page');
      } else {
        currentUser = null;
        loginLink.textContent = 'Login';
        adminLink.style.display = 'none';
        cart = {};
        updateCartUI();
        ordersList.innerHTML = '';
        if (products.length === 0) {
            loadProductsAndRenderBasedOnAuth();
        }
        adminOrdersList.innerHTML = '';
        
        showSplashScreen();
        pages.forEach(p => p.style.display = 'none');
      }
    });

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = link.getAttribute('href').substring(1) + '-page';

            if (link.id === 'login-link') {
                if (currentUser) {
                    signOut(auth);
                }
            } else if (currentUser) {
                showPage(targetId);
            } else {
                showAlert('Login Required', 'You need to be logged in to view this page.');
            }
        });
    });

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = loginForm['email'].value;
      const password = loginForm['password'].value;
      signInWithEmailAndPassword(auth, email, password)
        .catch(error => showAlert('Login Failed', error.message));
    });

    signupButton.addEventListener('click', () => {
      const email = loginForm['email'].value;
      const password = loginForm['password'].value;
      if(!email || !password) return showAlert('Input Required', 'Please enter both email and password.');
      createUserWithEmailAndPassword(auth, email, password)
        .then(cred => setDoc(doc(db, "users", cred.user.uid), { email, isAdmin: false, status: 'active' }))
        .catch(error => showAlert('Sign Up Failed', error.message));
    });

    resetButton.addEventListener('click', () => {
      const email = loginForm['email'].value;
      if (!email) {
        showAlert('Input Required', 'Please enter your email address to request a password reset.');
        return;
      }
      sendPasswordResetEmail(auth, email)
        .then(() => {
          showAlert(
            'Check Your Email', 
            `If an account exists for <strong>${email}</strong>, a password reset link has been sent. Please check your inbox and your spam folder for instructions.`
          );
        })
        .catch(error => {
          if (error.code === 'auth/too-many-requests') {
            showAlert('Too Many Requests', 'You have requested a password reset too many times. Please wait a few minutes before trying again.');
          } else {
            showAlert('Error', 'Could not send password reset email. Please try again.');
          }
          console.error("Password Reset Error:", error);
        });
    });

    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = products.filter(p =>
        (p.name || '').toLowerCase().includes(searchTerm) ||
        (p.category && p.category.toLowerCase().includes(searchTerm))
      );
      displayProducts(filtered);
    });
    
    paymentCompleteBtn.addEventListener('click', () => {
        showPage('orders-page');
    });

    checkoutForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (Object.keys(cart).length === 0) return showAlert('Empty Cart', 'Your cart is empty!');
      if (!currentUser) return showAlert('Login Required', 'Please log in first.');

      const paymentMethod = checkoutForm['payment-method'].value;
      const orderData = {
          userId: currentUser.uid,
          customerName: checkoutForm['name'].value,
          customerPhone: checkoutForm['phone'].value,
          customerAddress: checkoutForm['address'].value,
          items: Object.keys(cart).map(id => ({ productId: id, quantity: cart[id] })),
          total: parseFloat(cartTotalSpan.textContent.replace('Total: ₹', '')) || 0,
          paymentMethod: paymentMethod,
          status: paymentMethod === 'upi' ? 'Pending Payment' : 'Pending',
          timestamp: new Date()
      };

      try {
        await addDoc(collection(db, "orders"), orderData);

        const cartRef = collection(db, `users/${currentUser.uid}/cart`);
        const snap = await getDocs(cartRef);
        for (const d of snap.docs) await deleteDoc(d.ref);
        checkoutForm.reset();
        
        if (paymentMethod === 'upi') {
            document.getElementById('payment-amount').innerHTML = `<strong>₹${orderData.total.toFixed(2)}</strong>`;
            showPage('payment-gateway-page');
        } else {
            showAlert('Success', 'Order placed successfully!');
            showPage('orders-page');
        }

      } catch (err) {
        showAlert('Error', 'Failed to place order: ' + err.message);
      }
    });


    productForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!isAdmin) return showAlert('Permission Denied', 'You do not have permission.');
      
      const productId = productForm['product-id'].value;
      const priceValue = productForm['product-price'].value;
      if (isNaN(priceValue) || parseFloat(priceValue) < 0) {
        return showAlert('Invalid Input', 'Please enter a valid positive number for the price.');
      }
      const product = {
        name: productForm['product-name'].value,
        description: productForm['product-description'].value,
        price: parseFloat(priceValue),
        image: productForm['product-image'].value,
        category: productForm['product-category'].value,
        status: 'active'
      };

      if (productId) {
        updateDoc(doc(db, "products", productId), product)
          .then(() => {
            showAlert('Success', 'Product updated!');
            productForm.reset();
            document.getElementById('product-form-button').textContent = 'Add Product';
          })
          .catch(error => showAlert('Error', 'Error updating: ' + error.message));
      } else {
        addDoc(collection(db, "products"), product)
          .then(() => {
            showAlert('Success', 'Product added!');
            productForm.reset();
          })
          .catch(error => showAlert('Error', 'Error adding: ' + error.message));
      }
    });

    orderFilter.addEventListener('change', renderAdminOrdersFiltered);

  </script>
</body>
</html>

